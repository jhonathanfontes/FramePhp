{% extends "loja/layout.twig" %}

{% block title %}Produtos - {{ empresa.nome_fantasia }}{% endblock %}

{% block content %}
    <div class="products-page">
        <!-- Header da P√°gina -->
        <header class="page-header">
            <h1 class="page-title">üõçÔ∏è Nossos Produtos</h1>
            <p class="page-subtitle">Encontre os melhores produtos com qualidade garantida</p>
        </header>

        <!-- Filtros e Busca -->
        <section class="filters-section" aria-labelledby="filters-title">
            <div class="filters-container">
                <div class="search-box">
                    <input type="text" 
                           id="search-input" 
                           placeholder="Buscar produtos..." 
                           class="search-input"
                           aria-label="Buscar produtos">
                    <button type="button" class="search-btn" aria-label="Buscar">
                        üîç
                    </button>
                </div>

                <div class="filters-row">
                    <div class="filter-group">
                        <label for="category-filter" class="filter-label">Categoria</label>
                        <select id="category-filter" class="filter-select">
                            <option value="">Todas as Categorias</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="sort-filter" class="filter-label">Ordenar por</label>
                        <select id="sort-filter" class="filter-select">
                            <option value="recent">Mais Recentes</option>
                            <option value="name">Nome A-Z</option>
                            <option value="price-low">Menor Pre√ßo</option>
                            <option value="price-high">Maior Pre√ßo</option>
                            <option value="popular">Mais Populares</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="price-filter" class="filter-label">Faixa de Pre√ßo</label>
                        <select id="price-filter" class="filter-select">
                            <option value="">Qualquer Pre√ßo</option>
                            <option value="0-50">At√© R$ 50</option>
                            <option value="50-100">R$ 50 - R$ 100</option>
                            <option value="100-200">R$ 100 - R$ 200</option>
                            <option value="200+">Acima de R$ 200</option>
                        </select>
                    </div>
                </div>

                <div class="active-filters">
                    <span class="filter-tag">
                        Categoria: Eletr√¥nicos
                        <button class="remove-filter" aria-label="Remover filtro">√ó</button>
                    </span>
                    <span class="filter-tag">
                        Pre√ßo: R$ 50 - R$ 100
                        <button class="remove-filter" aria-label="Remover filtro">√ó</button>
                    </span>
                    <button class="clear-filters">Limpar Filtros</button>
                </div>
            </div>
        </section>

        <!-- Resultados -->
        <section class="results-section" aria-labelledby="results-title">
            <div class="results-header">
                <h2 id="results-title" class="results-title">
                    Produtos Encontrados
                    <span class="results-count">({{ produtos|length }} produtos)</span>
                </h2>
                
                <div class="view-options">
                    <button class="view-btn active" data-view="grid" aria-label="Visualiza√ß√£o em grade">
                        ‚äû
                    </button>
                    <button class="view-btn" data-view="list" aria-label="Visualiza√ß√£o em lista">
                        ‚ò∞
                    </button>
                </div>
            </div>

            {% if produtos %}
                <div class="products-grid" id="products-container">
                    {% for produto in produtos %}
                        <article class="product-card" data-product-id="{{ produto.id }}">
                            <div class="product-image">
                                {% if produto.imagem %}
                                    <img src="{{ produto.imagem }}" 
                                         alt="{{ produto.nome }}" 
                                         loading="lazy"
                                         class="product-img">
                                {% else %}
                                    <div class="product-placeholder">üì¶</div>
                                {% endif %}
                                
                                {% if produto.preco_promocional %}
                                    <span class="product-badge">Oferta</span>
                                {% endif %}
                                
                                <div class="product-overlay">
                                    <button class="quick-view-btn" 
                                            onclick="verProduto({{ produto.id }})"
                                            aria-label="Ver detalhes de {{ produto.nome }}">
                                        üëÅÔ∏è Ver Detalhes
                                    </button>
                                </div>
                            </div>
                            
                            <div class="product-content">
                                <div class="product-category">{{ produto.categoria.nome }}</div>
                                <h3 class="product-title">
                                    <a href="/produto/{{ produto.id }}">{{ produto.nome }}</a>
                                </h3>
                                <p class="product-description">
                                    {{ produto.descricao|slice(0, 80) }}{% if produto.descricao|length > 80 %}...{% endif %}
                                </p>
                                
                                <div class="product-price">
                                    <span class="price-current">
                                        R$ {{ "%.2f"|format(produto.preco) }}
                                    </span>
                                    {% if produto.preco_promocional %}
                                        <span class="price-old">
                                            R$ {{ "%.2f"|format(produto.preco_promocional) }}
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <div class="product-actions">
                                    <button class="btn btn-primary add-to-cart-btn" 
                                            onclick="adicionarAoCarrinho({{ produto.id }})"
                                            aria-label="Adicionar {{ produto.nome }} ao carrinho">
                                        üõí Adicionar
                                    </button>
                                    <button class="btn btn-secondary wishlist-btn" 
                                            onclick="adicionarAosFavoritos({{ produto.id }})"
                                            aria-label="Adicionar {{ produto.nome }} aos favoritos">
                                        ‚ù§Ô∏è
                                    </button>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>

                <!-- Pagina√ß√£o -->
                {% if pagination %}
                    <nav class="pagination" aria-label="Navega√ß√£o de p√°ginas">
                        {% if pagination.current_page > 1 %}
                            <a href="?page={{ pagination.current_page - 1 }}" class="pagination-btn">
                                ‚Üê Anterior
                            </a>
                        {% endif %}
                        
                        {% for page in range(1, pagination.last_page) %}
                            {% if page == pagination.current_page %}
                                <span class="pagination-btn active">{{ page }}</span>
                            {% else %}
                                <a href="?page={{ page }}" class="pagination-btn">{{ page }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.current_page < pagination.last_page %}
                            <a href="?page={{ pagination.current_page + 1 }}" class="pagination-btn">
                                Pr√≥xima ‚Üí
                            </a>
                        {% endif %}
                    </nav>
                {% endif %}
            {% else %}
                <!-- Estado Vazio -->
                <div class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h3>Nenhum produto encontrado</h3>
                    <p>Tente ajustar os filtros ou fazer uma nova busca</p>
                    <button class="btn btn-primary" onclick="limparFiltros()">
                        Limpar Filtros
                    </button>
                </div>
            {% endif %}
        </section>
    </div>

    <style>
        /* ===== PRODUCTS PAGE ===== */
        .products-page {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }
        
        .page-title {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            color: var(--text-color);
            margin-bottom: var(--spacing-sm);
        }
        
        .page-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }
        
        /* ===== FILTERS SECTION ===== */
        .filters-section {
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .filters-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .search-box {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .search-input {
            flex: 1;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: 2px solid var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .search-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .search-btn:hover {
            background: var(--secondary-color);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .filter-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .filter-select {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background: var(--bg-white);
        }
        
        .filter-select:focus {
            outline: 2px solid var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            align-items: center;
        }
        
        .filter-tag {
            background: var(--primary-color);
            color: var(--text-white);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .remove-filter {
            background: none;
            border: none;
            color: var(--text-white);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
        }
        
        .clear-filters {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }
        
        /* ===== RESULTS SECTION ===== */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .results-title {
            font-size: 1.3rem;
            color: var(--text-color);
            margin: 0;
        }
        
        .results-count {
            color: var(--text-light);
            font-weight: normal;
        }
        
        .view-options {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .view-btn {
            padding: var(--spacing-xs);
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .view-btn.active,
        .view-btn:hover {
            background: var(--primary-color);
            color: var(--text-white);
            border-color: var(--primary-color);
        }
        
        /* ===== PRODUCTS GRID ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .product-card {
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }
        
        .product-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .product-image {
            position: relative;
            height: 200px;
            overflow: hidden;
        }
        
        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }
        
        .product-card:hover .product-img {
            transform: scale(1.05);
        }
        
        .product-placeholder {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 3rem;
        }
        
        .product-badge {
            position: absolute;
            top: var(--spacing-xs);
            right: var(--spacing-xs);
            background: #ff6b6b;
            color: var(--text-white);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .product-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }
        
        .product-card:hover .product-overlay {
            opacity: 1;
        }
        
        .quick-view-btn {
            background: var(--text-white);
            color: var(--text-color);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
        }
        
        .product-content {
            padding: var(--spacing-md);
        }
        
        .product-category {
            color: var(--text-light);
            font-size: 0.8rem;
            margin-bottom: var(--spacing-xs);
        }
        
        .product-title {
            margin-bottom: var(--spacing-xs);
        }
        
        .product-title a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .product-title a:hover {
            color: var(--primary-color);
        }
        
        .product-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
            line-height: 1.4;
        }
        
        .product-price {
            margin-bottom: var(--spacing-md);
        }
        
        .price-current {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .price-old {
            text-decoration: line-through;
            color: var(--text-light);
            margin-left: var(--spacing-xs);
            font-size: 0.9rem;
        }
        
        .product-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .add-to-cart-btn {
            flex: 1;
        }
        
        .wishlist-btn {
            padding: var(--spacing-xs);
            min-width: 44px;
        }
        
        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }
        
        .pagination-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-light);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .pagination-btn:hover,
        .pagination-btn.active {
            background: var(--primary-color);
            color: var(--text-white);
            border-color: var(--primary-color);
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: var(--text-color);
            margin-bottom: var(--spacing-sm);
        }
        
        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: stretch;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: var(--spacing-md);
            }
            
            .product-actions {
                flex-direction: column;
            }
            
            .wishlist-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .active-filters {
                justify-content: center;
            }
        }
    </style>

    <script>
        // Fun√ß√µes de filtro e busca
        function aplicarFiltros() {
            const categoria = document.getElementById('category-filter').value;
            const ordenacao = document.getElementById('sort-filter').value;
            const preco = document.getElementById('price-filter').value;
            const busca = document.getElementById('search-input').value;
            
            // Construir URL com filtros
            const params = new URLSearchParams();
            if (categoria) params.append('categoria', categoria);
            if (ordenacao) params.append('ordenacao', ordenacao);
            if (preco) params.append('preco', preco);
            if (busca) params.append('busca', busca);
            
            // Redirecionar com filtros
            window.location.href = '/produtos?' + params.toString();
        }
        
        function limparFiltros() {
            document.getElementById('category-filter').value = '';
            document.getElementById('sort-filter').value = 'recent';
            document.getElementById('price-filter').value = '';
            document.getElementById('search-input').value = '';
            
            window.location.href = '/produtos';
        }
        
        // Adicionar ao carrinho
        function adicionarAoCarrinho(produtoId) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.classList.add('loading');
            button.innerHTML = '‚è≥';
            
            fetch('/carrinho/adicionar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    produto_id: produtoId,
                    quantidade: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.innerHTML = '‚úÖ Adicionado';
                    setTimeout(() => {
                        button.classList.remove('loading');
                        button.innerHTML = originalText;
                    }, 1000);
                    
                    mostrarNotificacao('Produto adicionado ao carrinho!', 'success');
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                button.classList.remove('loading');
                button.innerHTML = originalText;
                mostrarNotificacao('Erro ao adicionar produto: ' + error.message, 'error');
            });
        }
        
        // Adicionar aos favoritos
        function adicionarAosFavoritos(produtoId) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.classList.add('loading');
            button.innerHTML = '‚è≥';
            
            // Simular adi√ß√£o aos favoritos
            setTimeout(() => {
                button.classList.remove('loading');
                button.innerHTML = '‚ù§Ô∏è';
                mostrarNotificacao('Produto adicionado aos favoritos!', 'success');
            }, 500);
        }
        
        // Ver produto
        function verProduto(produtoId) {
            window.location.href = '/produto/' + produtoId;
        }
        
        // Alternar visualiza√ß√£o
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const view = this.dataset.view;
                const container = document.getElementById('products-container');
                
                if (view === 'list') {
                    container.style.gridTemplateColumns = '1fr';
                } else {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                }
            });
        });
        
        // Busca em tempo real
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                aplicarFiltros();
            }, 500);
        });
        
        // Aplicar filtros quando mudar
        document.getElementById('category-filter').addEventListener('change', aplicarFiltros);
        document.getElementById('sort-filter').addEventListener('change', aplicarFiltros);
        document.getElementById('price-filter').addEventListener('change', aplicarFiltros);
        
        // Buscar ao pressionar Enter
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                aplicarFiltros();
            }
        });
        
        // Buscar ao clicar no bot√£o
        document.querySelector('.search-btn').addEventListener('click', aplicarFiltros);
        
        // Remover filtros individuais
        document.querySelectorAll('.remove-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.remove();
                aplicarFiltros();
            });
        });
        
        // Limpar todos os filtros
        document.querySelector('.clear-filters').addEventListener('click', limparFiltros);
        
        function mostrarNotificacao(mensagem, tipo) {
            const notificacao = document.createElement('div');
            notificacao.className = `alert alert-${tipo}`;
            notificacao.setAttribute('role', 'alert');
            notificacao.setAttribute('aria-live', 'polite');
            notificacao.textContent = mensagem;
            
            const container = document.querySelector('.container');
            container.insertBefore(notificacao, container.firstChild);
            
            setTimeout(() => {
                notificacao.remove();
            }, 3000);
        }
    </script>
{% endblock %} 