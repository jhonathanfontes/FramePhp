{% extends "layouts/painel.html.twig" %}

{% block title %}Gest√£o de Usu√°rios - Sistema de Vendas{% endblock %}
{% block page_title %}Gest√£o de Usu√°rios{% endblock %}

{% block content %}
    <!-- Filtros e Busca -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Filtros</h2>
        </div>
        <form method="GET" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tipo</label>
                <select name="tipo" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 150px;">
                    <option value="">Todos os Tipos</option>
                    <option value="admin">Administrador</option>
                    <option value="gerente">Gerente</option>
                    <option value="operador">Operador</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status</label>
                <select name="status" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 150px;">
                    <option value="">Todos os Status</option>
                    <option value="Ativo">Ativos</option>
                    <option value="Inativo">Inativos</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Buscar</label>
                <input type="text" name="busca" value="{{ request.get('busca') }}" placeholder="Nome ou email" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 200px;">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">üîç Filtrar</button>
                <a href="/painel/usuarios" class="btn" style="background: #6c757d; color: white; margin-left: 0.5rem;">Limpar</a>
            </div>
        </form>
    </div>

    <!-- Estat√≠sticas R√°pidas -->
    <div class="grid grid-4">
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Usu√°rios</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #00d4ff; margin: 0;">{{ usuarios.total ?? 30 }}</p>
            </div>
        </div>
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Usu√°rios Ativos</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #27ae60; margin: 0;">{{ usuariosAtivos ?? 15 }}</p>
            </div>
        </div>
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Administradores</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin: 0;">{{ adminGeral ?? 10 }}</p>
            </div>
        </div>
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Gerentes</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #f39c12; margin: 0;">{{ adminEmpresa ?? 10 }}</p>
            </div>
        </div>
    </div>

    <!-- Lista de Usu√°rios -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">Usu√°rios</h2>
            <a href="/painel/usuarios/create" class="btn btn-primary">‚ûï Novo Usu√°rio</a>
        </div>
        <div class="card-body">
            {# Renderiza a tabela gerada pelo TableBuilder #}
            {% if usuariosTableHtml is defined %}
                {{ usuariosTableHtml|raw }}
            {% else %}
                <p style="text-align: center; color: #666; padding: 2rem;">Nenhum usu√°rio encontrado</p>
            {% endif %}
        </div>
    </div>

    <!-- A√ß√µes em Lote -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">A√ß√µes em Lote</h2>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="exportarUsuarios()" class="btn btn-primary">üìä Exportar Relat√≥rio</button>
            <button onclick="enviarEmails()" class="btn btn-primary">üìß Enviar Emails</button>
            <button onclick="resetSenhasEmLote()" class="btn btn-primary">üîë Resetar Senhas</button>
        </div>
    </div>

    <script>
        function exportarUsuarios() {
            const params = new URLSearchParams(window.location.search);
            window.open(`/painel/usuarios/exportar?${params.toString()}`, '_blank');
        }
        function enviarEmails() {
            if (confirm('Deseja enviar emails para todos os usu√°rios ativos?')) {
                fetch('/painel/usuarios/enviar-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Emails enviados com sucesso!');
                    } else {
                        alert('Erro ao enviar emails: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao enviar emails');
                });
            }
        }
        function resetSenhasEmLote() {
            if (confirm('Deseja resetar as senhas de todos os usu√°rios selecionados?')) {
                // Implemente a l√≥gica de sele√ß√£o de usu√°rios se necess√°rio
                alert('Funcionalidade em desenvolvimento.');
            }
        }
    </script>
{% endblock %}