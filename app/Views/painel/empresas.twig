{% extends "painel/layout.twig" %}

{% block title %}Gest√£o de Empresas - Sistema de Vendas{% endblock %}
{% block page_title %}Gest√£o de Empresas{% endblock %}

{% block content %}
    <!-- Filtros e Busca -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Filtros</h2>
        </div>
        <form method="GET" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status</label>
                <select name="status" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 150px;">
                    <option value="">Todos os Status</option>
                    <option value="ativo" {% if request.get('status') == 'ativo' %}selected{% endif %}>Ativas</option>
                    <option value="inativo" {% if request.get('status') == 'inativo' %}selected{% endif %}>Inativas</option>
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Buscar</label>
                <input type="text" name="busca" value="{{ request.get('busca') }}" placeholder="Nome, CNPJ ou email" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 250px;">
            </div>
            
            <div>
                <button type="submit" class="btn btn-primary">üîç Filtrar</button>
                <a href="/painel/empresas" class="btn" style="background: #6c757d; color: white; margin-left: 0.5rem;">Limpar</a>
            </div>
        </form>
    </div>

    <!-- Estat√≠sticas R√°pidas -->
    <div class="grid grid-4">
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Empresas</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #00d4ff; margin: 0;">{{ empresas.total }}</p>
            </div>
        </div>
        
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Empresas Ativas</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #27ae60; margin: 0;">{{ empresasAtivas }}</p>
            </div>
        </div>
        
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Vendas Totais</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin: 0;">{{ totalVendas }}</p>
            </div>
        </div>
        
        <div class="card">
            <div style="text-align: center;">
                <h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Receita Total</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #f39c12; margin: 0;">R$ {{ "%.2f"|format(receitaTotal) }}</p>
            </div>
        </div>
    </div>

    <!-- Lista de Empresas -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">Empresas</h2>
            <a href="/painel/empresas/create" class="btn btn-primary">‚ûï Nova Empresa</a>
        </div>
        
        {% if empresas.data %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th>CNPJ</th>
                        <th>Contato</th>
                        <th>Vendas</th>
                        <th>Receita</th>
                        <th>Status</th>
                        <th>Data Cadastro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for empresa in empresas.data %}
                        <tr>
                            <td>
                                <div>
                                    <a href="/painel/empresas/{{ empresa.id }}" style="color: #00d4ff; text-decoration: none; font-weight: bold;">
                                        {{ empresa.nome_fantasia }}
                                    </a>
                                    <br>
                                    <small style="color: #666;">{{ empresa.razao_social }}</small>
                                </div>
                            </td>
                            <td>{{ empresa.cnpj }}</td>
                            <td>
                                <div>
                                    <div>{{ empresa.email }}</div>
                                    <small style="color: #666;">{{ empresa.telefone }}</small>
                                </div>
                            </td>
                            <td>
                                <span style="font-weight: bold; color: #00d4ff;">{{ empresa.total_vendas }}</span>
                            </td>
                            <td>
                                <span style="font-weight: bold; color: #27ae60;">R$ {{ "%.2f"|format(empresa.receita_total) }}</span>
                            </td>
                            <td>
                                <span class="badge {% if empresa.ativo %}badge-success{% else %}badge-danger{% endif %}">
                                    {{ empresa.ativo ? 'Ativa' : 'Inativa' }}
                                </span>
                            </td>
                            <td>{{ empresa.data_cadastro|date('d/m/Y') }}</td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="/painel/empresas/{{ empresa.id }}" class="btn" style="background: #00d4ff; color: white; padding: 0.3rem 0.6rem; font-size: 0.8rem;">üëÅÔ∏è</a>
                                    <a href="/painel/empresas/{{ empresa.id }}/edit" class="btn" style="background: #f39c12; color: white; padding: 0.3rem 0.6rem; font-size: 0.8rem;">‚úèÔ∏è</a>
                                    <button onclick="toggleStatus({{ empresa.id }})" class="btn" style="background: {{ empresa.ativo ? '#e74c3c' : '#27ae60' }}; color: white; padding: 0.3rem 0.6rem; font-size: 0.8rem; border: none; cursor: pointer;">
                                        {{ empresa.ativo ? '‚ùå' : '‚úÖ' }}
                                    </button>
                                    {% if empresa.total_vendas == 0 %}
                                        <button onclick="deletarEmpresa({{ empresa.id }})" class="btn" style="background: #dc3545; color: white; padding: 0.3rem 0.6rem; font-size: 0.8rem; border: none; cursor: pointer;">üóëÔ∏è</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Pagina√ß√£o -->
            {% if empresas.last_page > 1 %}
                <div style="display: flex; justify-content: center; margin-top: 2rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        {% if empresas.current_page > 1 %}
                            <a href="?page={{ empresas.current_page - 1 }}{% if request.get('status') %}&status={{ request.get('status') }}{% endif %}{% if request.get('busca') %}&busca={{ request.get('busca') }}{% endif %}" class="btn" style="background: #6c757d; color: white;">‚Üê Anterior</a>
                        {% endif %}
                        
                        {% for page in range(1, empresas.last_page) %}
                            {% if page == empresas.current_page %}
                                <span class="btn" style="background: #00d4ff; color: white;">{{ page }}</span>
                            {% else %}
                                <a href="?page={{ page }}{% if request.get('status') %}&status={{ request.get('status') }}{% endif %}{% if request.get('busca') %}&busca={{ request.get('busca') }}{% endif %}" class="btn" style="background: #6c757d; color: white;">{{ page }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if empresas.current_page < empresas.last_page %}
                            <a href="?page={{ empresas.current_page + 1 }}{% if request.get('status') %}&status={{ request.get('status') }}{% endif %}{% if request.get('busca') %}&busca={{ request.get('busca') }}{% endif %}" class="btn" style="background: #6c757d; color: white;">Pr√≥ximo ‚Üí</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 2rem;">Nenhuma empresa encontrada</p>
        {% endif %}
    </div>

    <!-- A√ß√µes em Lote -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">A√ß√µes em Lote</h2>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="exportarEmpresas()" class="btn btn-primary">üìä Exportar Relat√≥rio</button>
            <button onclick="enviarEmails()" class="btn btn-primary">üìß Enviar Emails</button>
            <button onclick="gerarBackup()" class="btn btn-primary">üíæ Gerar Backup</button>
        </div>
    </div>

    <script>
        function toggleStatus(empresaId) {
            if (confirm('Deseja alterar o status desta empresa?')) {
                fetch(`/painel/empresas/${empresaId}/toggle-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Status alterado com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao alterar status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao alterar status');
                });
            }
        }

        function deletarEmpresa(empresaId) {
            if (confirm('Tem certeza que deseja excluir esta empresa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                fetch(`/painel/empresas/${empresaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Empresa exclu√≠da com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao excluir empresa: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir empresa');
                });
            }
        }

        function exportarEmpresas() {
            const params = new URLSearchParams(window.location.search);
            window.open(`/painel/empresas/exportar?${params.toString()}`, '_blank');
        }

        function enviarEmails() {
            if (confirm('Deseja enviar emails para todas as empresas ativas?')) {
                fetch('/painel/empresas/enviar-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Emails enviados com sucesso!');
                    } else {
                        alert('Erro ao enviar emails: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao enviar emails');
                });
            }
        }

        function gerarBackup() {
            if (confirm('Deseja gerar um backup completo do sistema?')) {
                fetch('/painel/backup/gerar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Backup gerado com sucesso!');
                        if (data.download_url) {
                            window.open(data.download_url, '_blank');
                        }
                    } else {
                        alert('Erro ao gerar backup: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar backup');
                });
            }
        }
    </script>
{% endblock %} 