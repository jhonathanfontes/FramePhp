{% extends 'layouts/painel.html.twig' %}

{% block title %}Meu Perfil - Painel Administrativo{% endblock %}
{% block page_title %}Meu Perfil{% endblock %}

{% block content %}
<div class="row">
    <!-- Informações do Perfil -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Informações do Perfil</h6>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <div class="profile-image-container">
                        {% if usuario.foto %}
                            <img src="{{ usuario.foto }}" alt="Foto do Perfil" class="profile-image">
                        {% else %}
                            <div class="profile-image-placeholder">
                                <i class="fas fa-user fa-3x"></i>
                            </div>
                        {% endif %}
                        <button class="btn btn-sm btn-primary change-photo-btn" onclick="document.getElementById('fotoInput').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="fotoInput" accept="image/*" style="display: none;" onchange="uploadFoto(this)">
                </div>
                
                <h5 class="font-weight-bold">{{ usuario.nome }}</h5>
                <p class="text-muted">{{ usuario.email }}</p>
                
                <div class="row text-center mt-4">
                    <div class="col-6">
                        <div class="border-right">
                            <h6 class="font-weight-bold">{{ usuario.total_empresas ?? 0 }}</h6>
                            <small class="text-muted">Empresas</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="font-weight-bold">{{ usuario.total_estabelecimentos ?? 0 }}</h6>
                        <small class="text-muted">Estabelecimentos</small>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="text-left">
                    <p><strong>Status:</strong> 
                        <span class="badge bg-{{ usuario.status == 'ativo' ? 'success' : 'secondary' }}">
                            {{ usuario.status|title }}
                        </span>
                    </p>
                    <p><strong>Último Login:</strong> {{ usuario.ultimo_login|date('d/m/Y H:i') ?? 'Nunca' }}</p>
                    <p><strong>Membro desde:</strong> {{ usuario.created_at|date('d/m/Y') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário de Edição -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Editar Perfil</h6>
            </div>
            <div class="card-body">
                <form action="/painel/perfil/atualizar" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   value="{{ usuario.nome }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ usuario.email }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="telefone" name="telefone" 
                                   value="{{ usuario.telefone ?? '' }}" placeholder="(11) 99999-9999">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" 
                                   value="{{ usuario.cpf ?? '' }}" placeholder="000.000.000-00">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" 
                                   value="{{ usuario.data_nascimento ?? '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="genero" class="form-label">Gênero</label>
                            <select class="form-select" id="genero" name="genero">
                                <option value="">Selecione...</option>
                                <option value="M" {{ usuario.genero == 'M' ? 'selected' : '' }}>Masculino</option>
                                <option value="F" {{ usuario.genero == 'F' ? 'selected' : '' }}>Feminino</option>
                                <option value="O" {{ usuario.genero == 'O' ? 'selected' : '' }}>Outro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <textarea class="form-control" id="endereco" name="endereco" rows="2" 
                                  placeholder="Rua, número, complemento, bairro, cidade - UF">{{ usuario.endereco ?? '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep" name="cep" 
                                   value="{{ usuario.cep ?? '' }}" placeholder="00000-000">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade" name="cidade" 
                                   value="{{ usuario.cidade ?? '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado">
                                <option value="">Selecione...</option>
                                <option value="AC" {{ usuario.estado == 'AC' ? 'selected' : '' }}>Acre</option>
                                <option value="AL" {{ usuario.estado == 'AL' ? 'selected' : '' }}>Alagoas</option>
                                <option value="AP" {{ usuario.estado == 'AP' ? 'selected' : '' }}>Amapá</option>
                                <option value="AM" {{ usuario.estado == 'AM' ? 'selected' : '' }}>Amazonas</option>
                                <option value="BA" {{ usuario.estado == 'BA' ? 'selected' : '' }}>Bahia</option>
                                <option value="CE" {{ usuario.estado == 'CE' ? 'selected' : '' }}>Ceará</option>
                                <option value="DF" {{ usuario.estado == 'DF' ? 'selected' : '' }}>Distrito Federal</option>
                                <option value="ES" {{ usuario.estado == 'ES' ? 'selected' : '' }}>Espírito Santo</option>
                                <option value="GO" {{ usuario.estado == 'GO' ? 'selected' : '' }}>Goiás</option>
                                <option value="MA" {{ usuario.estado == 'MA' ? 'selected' : '' }}>Maranhão</option>
                                <option value="MT" {{ usuario.estado == 'MT' ? 'selected' : '' }}>Mato Grosso</option>
                                <option value="MS" {{ usuario.estado == 'MS' ? 'selected' : '' }}>Mato Grosso do Sul</option>
                                <option value="MG" {{ usuario.estado == 'MG' ? 'selected' : '' }}>Minas Gerais</option>
                                <option value="PA" {{ usuario.estado == 'PA' ? 'selected' : '' }}>Pará</option>
                                <option value="PB" {{ usuario.estado == 'PB' ? 'selected' : '' }}>Paraíba</option>
                                <option value="PR" {{ usuario.estado == 'PR' ? 'selected' : '' }}>Paraná</option>
                                <option value="PE" {{ usuario.estado == 'PE' ? 'selected' : '' }}>Pernambuco</option>
                                <option value="PI" {{ usuario.estado == 'PI' ? 'selected' : '' }}>Piauí</option>
                                <option value="RJ" {{ usuario.estado == 'RJ' ? 'selected' : '' }}>Rio de Janeiro</option>
                                <option value="RN" {{ usuario.estado == 'RN' ? 'selected' : '' }}>Rio Grande do Norte</option>
                                <option value="RS" {{ usuario.estado == 'RS' ? 'selected' : '' }}>Rio Grande do Sul</option>
                                <option value="RO" {{ usuario.estado == 'RO' ? 'selected' : '' }}>Rondônia</option>
                                <option value="RR" {{ usuario.estado == 'RR' ? 'selected' : '' }}>Roraima</option>
                                <option value="SC" {{ usuario.estado == 'SC' ? 'selected' : '' }}>Santa Catarina</option>
                                <option value="SP" {{ usuario.estado == 'SP' ? 'selected' : '' }}>São Paulo</option>
                                <option value="SE" {{ usuario.estado == 'SE' ? 'selected' : '' }}>Sergipe</option>
                                <option value="TO" {{ usuario.estado == 'TO' ? 'selected' : '' }}>Tocantins</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="biografia" class="form-label">Biografia</label>
                        <textarea class="form-control" id="biografia" name="biografia" rows="3" 
                                  placeholder="Conte um pouco sobre você...">{{ usuario.biografia ?? '' }}</textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Restaurar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Alterar Senha -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Alterar Senha</h6>
            </div>
            <div class="card-body">
                <form action="/painel/perfil/alterar-senha" method="POST" id="formAlterarSenha">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="senha_atual" class="form-label">Senha Atual</label>
                            <input type="password" class="form-control" id="senha_atual" name="senha_atual" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="nova_senha" class="form-label">Nova Senha</label>
                            <input type="password" class="form-control" id="nova_senha" name="nova_senha" 
                                   required minlength="8">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="confirmar_senha" class="form-label">Confirmar Nova Senha</label>
                            <input type="password" class="form-control" id="confirmar_senha" name="confirmar_senha" 
                                   required minlength="8">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="password-strength" id="passwordStrength"></div>
                        <div class="password-match mt-2" id="passwordMatch"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-warning" id="btnAlterarSenha" disabled>
                        <i class="fas fa-key me-2"></i>Alterar Senha
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preferências -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Preferências</h6>
            </div>
            <div class="card-body">
                <form action="/painel/perfil/preferencias" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="idioma" class="form-label">Idioma</label>
                            <select class="form-select" id="idioma" name="idioma">
                                <option value="pt_BR" {{ usuario.preferencias.idioma == 'pt_BR' ? 'selected' : '' }}>Português (Brasil)</option>
                                <option value="en_US" {{ usuario.preferencias.idioma == 'en_US' ? 'selected' : '' }}>English (US)</option>
                                <option value="es_ES" {{ usuario.preferencias.idioma == 'es_ES' ? 'selected' : '' }}>Español</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="timezone" class="form-label">Fuso Horário</label>
                            <select class="form-select" id="timezone" name="timezone">
                                <option value="America/Sao_Paulo" {{ usuario.preferencias.timezone == 'America/Sao_Paulo' ? 'selected' : '' }}>São Paulo (GMT-3)</option>
                                <option value="America/Manaus" {{ usuario.preferencias.timezone == 'America/Manaus' ? 'selected' : '' }}>Manaus (GMT-4)</option>
                                <option value="America/Belem" {{ usuario.preferencias.timezone == 'America/Belem' ? 'selected' : '' }}>Belém (GMT-3)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notificações</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_notificacoes" name="email_notificacoes" 
                                   {{ usuario.preferencias.email_notificacoes ? 'checked' : '' }}>
                            <label class="form-check-label" for="email_notificacoes">
                                Receber notificações por e-mail
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sms_notificacoes" name="sms_notificacoes" 
                                   {{ usuario.preferencias.sms_notificacoes ? 'checked' : '' }}>
                            <label class="form-check-label" for="sms_notificacoes">
                                Receber notificações por SMS
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="push_notificacoes" name="push_notificacoes" 
                                   {{ usuario.preferencias.push_notificacoes ? 'checked' : '' }}>
                            <label class="form-check-label" for="push_notificacoes">
                                Receber notificações push
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-cog me-2"></i>Salvar Preferências
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Máscaras para campos
    if (typeof IMask !== 'undefined') {
        IMask(document.getElementById('telefone'), {
            mask: '(00) 00000-0000'
        });
        
        IMask(document.getElementById('cpf'), {
            mask: '000.000.000-00'
        });
        
        IMask(document.getElementById('cep'), {
            mask: '00000-000'
        });
    }
    
    // Validação de senha
    const novaSenha = document.getElementById('nova_senha');
    const confirmarSenha = document.getElementById('confirmar_senha');
    const btnAlterarSenha = document.getElementById('btnAlterarSenha');
    
    function checkPasswordMatch() {
        const matchDiv = document.getElementById('passwordMatch');
        const novaSenhaValue = novaSenha.value;
        const confirmarSenhaValue = confirmarSenha.value;
        
        if (confirmarSenhaValue === '') {
            matchDiv.textContent = '';
            matchDiv.className = 'password-match';
            return false;
        }
        
        if (novaSenhaValue === confirmarSenhaValue) {
            matchDiv.textContent = '✓ Senhas coincidem';
            matchDiv.className = 'password-match match';
            return true;
        } else {
            matchDiv.textContent = '✗ Senhas não coincidem';
            matchDiv.className = 'password-match no-match';
            return false;
        }
    }
    
    function checkPasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrength');
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        const metCount = Object.values(requirements).filter(Boolean).length;
        const strengthPercentage = (metCount / 5) * 100;
        
        let strengthColor, strengthLabel;
        if (strengthPercentage <= 20) {
            strengthColor = '#dc3545';
            strengthLabel = 'Muito Fraca';
        } else if (strengthPercentage <= 40) {
            strengthColor = '#fd7e14';
            strengthLabel = 'Fraca';
        } else if (strengthPercentage <= 60) {
            strengthColor = '#ffc107';
            strengthLabel = 'Média';
        } else if (strengthPercentage <= 80) {
            strengthColor = '#20c997';
            strengthLabel = 'Forte';
        } else {
            strengthColor = '#28a745';
            strengthLabel = 'Muito Forte';
        }
        
        strengthBar.innerHTML = `
            <div class="password-strength-bar" style="width: ${strengthPercentage}%; background-color: ${strengthColor};"></div>
            <div class="password-strength-text" style="color: ${strengthColor};">Força: ${strengthLabel}</div>
        `;
        
        return metCount >= 4; // Mínimo 4 requisitos atendidos
    }
    
    function updateAlterarSenhaButton() {
        const senhaAtual = document.getElementById('senha_atual').value;
        const novaSenhaValue = novaSenha.value;
        const confirmarSenhaValue = confirmarSenha.value;
        
        const senhaForte = checkPasswordStrength(novaSenhaValue);
        const senhasCoincidem = checkPasswordMatch();
        const todosPreenchidos = senhaAtual && novaSenhaValue && confirmarSenhaValue;
        
        btnAlterarSenha.disabled = !(senhaForte && senhasCoincidem && todosPreenchidos);
    }
    
    novaSenha.addEventListener('input', updateAlterarSenhaButton);
    confirmarSenha.addEventListener('input', updateAlterarSenhaButton);
    document.getElementById('senha_atual').addEventListener('input', updateAlterarSenhaButton);
});

function uploadFoto(input) {
    if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('foto', input.files[0]);
        
        fetch('/painel/perfil/upload-foto', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao fazer upload da foto: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao fazer upload da foto. Tente novamente.');
        });
    }
}

function resetForm() {
    if (confirm('Deseja restaurar os dados originais? Todas as alterações serão perdidas.')) {
        location.reload();
    }
}
</script>

<style>
.profile-image-container {
    position: relative;
    display: inline-block;
}

.profile-image {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #fff;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.profile-image-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4e73df, #224abe);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border: 4px solid #fff;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.change-photo-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.password-strength {
    height: 4px;
    background-color: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.password-strength-bar {
    height: 100%;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.password-strength-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.password-match {
    font-size: 0.875rem;
    font-weight: 500;
}

.password-match.match {
    color: #28a745;
}

.password-match.no-match {
    color: #dc3545;
}

.border-right {
    border-right: 1px solid #e3e6f0;
}

.form-control:focus,
.form-select:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn {
    border-radius: 6px;
    font-weight: 500;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %} 