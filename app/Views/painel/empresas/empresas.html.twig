{% extends "layouts/painel.html.twig" %}

{% block title %}Gestão de Empresas - Sistema de Vendas
{% endblock %}
{% block page_title %}Gestão de Empresas
{% endblock %}

{% block content %}
	<!-- Filtros e Busca -->
	<div class="card">
		<div class="card-header">
			<h2 class="card-title">Filtros</h2>
		</div>
		<form method="GET" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
			<div>
				<label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status</label>
				<select name="status" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 150px;">
					<option value="">Todos os Status</option>
					<option value="ativo" {% if request.get('status') == 'ativo' %} selected {% endif %}>Ativas</option>
					<option value="inativo" {% if request.get('status') == 'inativo' %} selected {% endif %}>Inativas</option>
				</select>
			</div>
			<div>
				<label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Buscar</label>
				<input type="text" name="busca" value="{{ request.get('busca') }}" placeholder="Nome, CNPJ ou email" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; min-width: 200px;">
			</div>
			<div>
				<button type="submit" class="btn btn-primary">🔍 Filtrar</button>
				<a href="/painel/empresas" class="btn" style="background: #6c757d; color: white; margin-left: 0.5rem;">Limpar</a>
			</div>
		</form>
	</div>

	<!-- Estatísticas Rápidas -->
	<div class="grid grid-4">
		<div class="card">
			<div style="text-align: center;">
				<span style="font-size: 2rem;">🏢</span>
				<h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Empresas</h3>
				<p style="font-size: 2rem; font-weight: bold; color: #00d4ff; margin: 0;">{{ empresas.total }}</p>
			</div>
		</div>
		<div class="card">
			<div style="text-align: center;">
				<span style="font-size: 2rem;">✅</span>
				<h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Empresas Ativas</h3>
				<p style="font-size: 2rem; font-weight: bold; color: #27ae60; margin: 0;">{{ empresasAtivas }}</p>
			</div>
		</div>
		<div class="card">
			<div style="text-align: center;">
				<span style="font-size: 2rem;">📈</span>
				<h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Vendas Totais</h3>
				<p style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin: 0;">{{ totalVendas }}</p>
			</div>
		</div>
		<div class="card">
			<div style="text-align: center;">
				<span style="font-size: 2rem;">💰</span>
				<h3 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Receita Total</h3>
				<p style="font-size: 2rem; font-weight: bold; color: #f39c12; margin: 0;">R$
					{{ "%.2f"|format(receitaTotal) }}</p>
			</div>
		</div>
	</div>

	<!-- Lista de Empresas -->
	<div class="card">
		<div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
			<h2 class="card-title">Empresas</h2>
			<a href="{{ url('painel.empresa.create') }}" class="btn btn-primary">➕ Nova Empresa</a>
		</div>
		<!-- Tabela de empresas -->
			
				{% if empresasTableHtml is defined %}
					{{ empresasTableHtml | raw }}
				{% else %}
					<div class="notification is-warning">
						A tabela de produtos não foi gerada ou não há dados.
					</div>
				{% endif %}
	
	</div>

	<!-- Ações em Lote -->
	<div class="card">
		<div class="card-header">
			<h2 class="card-title">Ações em Lote</h2>
		</div>
		<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
			<button onclick="exportarEmpresas()" class="btn btn-primary">📊 Exportar Relatório</button>
			<button onclick="enviarEmails()" class="btn btn-primary">📧 Enviar Emails</button>
			<button onclick="gerarBackup()" class="btn btn-primary">💾 Gerar Backup</button>
		</div>
	</div>

	 <script>
	        function toggleStatus(empresaId) {
	            if (confirm('Deseja alterar o status desta empresa?')) {
	                fetch(`/painel/empresas/${empresaId}/toggle-status`, {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
	                    }
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.success) {
	                        alert('Status alterado com sucesso!');
	                        location.reload();
	                    } else {
	                        alert('Erro ao alterar status: ' + data.message);
	                    }
	                })
	                .catch(error => {
	                    console.error('Erro:', error);
	                    alert('Erro ao alterar status');
	                });
	            }
	        }
	
	        function deletarEmpresa(empresaId) {
	            if (confirm('Tem certeza que deseja excluir esta empresa? Esta ação não pode ser desfeita.')) {
	                fetch(`/painel/empresas/${empresaId}`, {
	                    method: 'DELETE',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
	                    }
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.success) {
	                        alert('Empresa excluída com sucesso!');
	                        location.reload();
	                    } else {
	                        alert('Erro ao excluir empresa: ' + data.message);
	                    }
	                })
	                .catch(error => {
	                    console.error('Erro:', error);
	                    alert('Erro ao excluir empresa');
	                });
	            }
	        }
	
	        function exportarEmpresas() {
	            const params = new URLSearchParams(window.location.search);
	            window.open(`/painel/empresas/exportar?${params.toString()}`, '_blank');
	        }
	
	        function enviarEmails() {
	            if (confirm('Deseja enviar emails para todas as empresas ativas?')) {
	                fetch('/painel/empresas/enviar-emails', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
	                    }
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.success) {
	                        alert('Emails enviados com sucesso!');
	                    } else {
	                        alert('Erro ao enviar emails: ' + data.message);
	                    }
	                })
	                .catch(error => {
	                    console.error('Erro:', error);
	                    alert('Erro ao enviar emails');
	                });
	            }
	        }
	
	        function gerarBackup() {
	            if (confirm('Deseja gerar backup dos dados das empresas?')) {
	                fetch('/painel/empresas/gerar-backup', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json',
	                        'X-CSRF-TOKEN': '{{ csrf_token() }}'
	                    }
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.success) {
	                        alert('Backup gerado com sucesso!');
	                    } else {
	                        alert('Erro ao gerar backup: ' + data.message);
	                    }
	                })
	                .catch(error => {
	                    console.error('Erro:', error);
	                    alert('Erro ao gerar backup');
	                });
	            }
	        }
	    </script>
{% endblock %}
